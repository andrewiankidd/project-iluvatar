apiVersion: batch/v1
kind: Job
metadata:
  name: omni-cluster-template-sync
  namespace: ainur-sidero-omni
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 3600
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: sync-template
          image: alpine:3.20
          env:
            - name: REPO_URL
              value: https://github.com/andrewiankidd/project-iluvatar
            - name: REPO_REF
              value: main
            - name: TEMPLATE_PATH
              value: src/manifests/ainur/sidero-omni/omni-config/omni-cluster-template.yaml
            - name: OMNICTL_URL
              value: https://github.com/siderolabs/omni/releases/latest/download/omnictl-linux-arm64
          command:
            - sh
            - -c
            - |
              set -eu
              apk add --no-cache ca-certificates curl git gettext
              # trust lab CA for omnictl grpc/http calls
              cat /etc/omni/lab-root-ca.crt >> /etc/ssl/certs/ca-certificates.crt
              curl -fsSL -L "$OMNICTL_URL" -o /usr/local/bin/omnictl
              chmod +x /usr/local/bin/omnictl

              mkdir -p /root/.talos/keys
              cp /etc/omni/omni.asc /root/.talos/keys/default-omni@local.pgp

              workdir="$(mktemp -d)"
              cd "$workdir"
              git init -q
              git remote add origin "$REPO_URL"
              git config core.sparseCheckout true
              echo "$TEMPLATE_PATH" > .git/info/sparse-checkout
              git fetch -q --depth 1 origin "$REPO_REF"
              git checkout -q FETCH_HEAD

              export LAB_ROOT_CA_INDENTED
              LAB_ROOT_CA_INDENTED="$(sed 's/^/        /' /etc/omni/lab-root-ca.crt)"
              envsubst < "$TEMPLATE_PATH" > /tmp/omni-cluster-template.rendered.yaml

              omnictl \
                --omniconfig /etc/omnictl/omniconfig.yaml \
                cluster template sync \
                -f /tmp/omni-cluster-template.rendered.yaml
          volumeMounts:
            - name: omnictl-config
              mountPath: /etc/omnictl
              readOnly: true
            - name: omni-gpg
              mountPath: /etc/omni/omni.asc
              subPath: omni.asc
              readOnly: true
            - name: omnictl-keys
              mountPath: /root/.talos/keys
            - name: lab-root-ca
              mountPath: /etc/omni/lab-root-ca.crt
              subPath: ca.crt
              readOnly: true
      volumes:
        - name: omnictl-config
          secret:
            secretName: omnictl-config
        - name: omni-gpg
          secret:
            secretName: omni-gpg
        - name: omnictl-keys
          emptyDir: {}
        - name: lab-root-ca
          configMap:
            name: lab-ca
